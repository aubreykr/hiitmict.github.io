---
title: "HIIT vs. MICT"
output:
  html_document:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
---

This is designed to track study progress!

```{r setup, include=FALSE}
# Load packages
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(ggplot2)
library(table1)
library(lubridate)
library(knitr)
library(kableExtra)
library(ggpubr)
library(stringr)
library(zoo)
library(ggrepel)
```

```{r demog, message=FALSE, warning=FALSE, echo=FALSE}
# Read in the data generated by REDCapAPI.Rmd
demog<-read.csv("~/Google Drive/Shared drives/HIIT and Endurance Study/Data/data/pheno/raw/redcap/Processed_Data/64208_Demographics_Processed.csv")

#----Data Cleaning, features----------
# Pull in data to see if EP surveys are done
epsurveys<-read.csv("~/Google Drive/Shared drives/HIIT and Endurance Study/Data/data/pheno/raw/redcap/Raw_Data/64208_WorkoutDates_Raw.csv")
epsurveys<-epsurveys %>% 
  dplyr::select(record_id, redcap_event_name, perceived_stress_scale_pss10_complete)
epsurveys<-epsurveys %>% 
  filter(redcap_event_name == "week_12_ep_surveys_arm_1")
epsurveys<-epsurveys %>% 
  dplyr::rename(EP_surveys = perceived_stress_scale_pss10_complete) %>% 
  dplyr::select(record_id, EP_surveys)
epsurveys<-epsurveys %>% 
  mutate(EP_surveys = ifelse(EP_surveys == "Complete", "YES", ""))

# Create variable for crossover ppts
demog<-demog %>% 
  mutate(crossover = ifelse(record_id >=1000, "yes", "no"))

# Calculate expected num of workouts based on week they are on
demog$expected_num <- gsub("Week ", "", demog$current_week)
demog$expected_num <- (as.numeric(demog$expected_num) - 1)*3

# Flag people who need to be extended
demog$EXTEND <- ifelse(demog$expected_num - demog$total_workouts_in_REDCap >=4, "YES", " ")
demog$EXTEND[demog$Group == "Control"]<- " "

# EP vo2 complete?
demog$EP_VO2[is.na(demog$ep_vo2_max)==FALSE] <- "YES"
demog$EP_VO2[is.na(demog$ep_vo2_max)==TRUE] <- " "

# if missing, they have enrolled and update this
demog$enrollment_status[is.na(demog$enrollment_status) == TRUE] <- "Enrolled (not screened yet)"

# Specify order of weeks for plots
demog$current_week <- factor(demog$current_week, levels=c("Not Training Yet", "Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6", "Week 7", "Week 8", "Week 9", "Week 10", "Week 11", "Week 12", "Week 13", "Week 14", "Week 15"))

# new column for target HR zone depending on group
demog<-demog %>% 
  mutate(HR_zone = case_when(Group == "MICT" ~ bl_heart_rate_mict,
                             Group == "HIIT" ~ bl_heart_rate_hiit))

# manually assign HR zone for crossover records
demog$HR_zone[demog$record_id == "1070"] <- "122-134"
demog$HR_zone[demog$record_id == "1076"] <- "114-126"
demog$HR_zone[demog$record_id == "1103"] <- "133-149"
demog$HR_zone[demog$record_id == "1112"] <- "141-162"
demog$HR_zone[demog$record_id == "1116"] <- "112-120"

demog<-full_join(demog, epsurveys, by=c("record_id"))

# Create sex + agebin variable
demog$strata[demog$sex == "Female" & demog$agegroup == "18-35 yrs"]<-"F, 18-35"
demog$strata[demog$sex == "Female" & demog$agegroup == "36-65 yrs"]<-"F, 36-65"
demog$strata[demog$sex == "Male" & demog$agegroup == "18-35 yrs"]<-"M, 18-35"
demog$strata[demog$sex == "Male" & demog$agegroup == "36-65 yrs"]<-"M, 36-65"

# Recode variables
demog$bl_VO2 <- ifelse(is.na(demog$bl_vo2_max), "No", "Yes")
demog$ep_trainingtest_date_done <- ifelse(is.na(demog$ep_trainingtest_date), " ", "YES")

```


This was last updated on `r format(Sys.Date(), format="%B %d, %Y")`.

## Study Complete âœ…

In total, 90 participants completed the 12-week training intervention and all pre/post-study visits.

```{r newppl, message=FALSE, warning=FALSE, echo=FALSE}
# Order levels of enrollment status
demog<-demog %>% 
  mutate(enrollment_status = ifelse(is.na(ep_vo2_max)==FALSE & record_id<1000, "Completed", ifelse(
    is.na(ep_vo2_max)==FALSE & record_id>1000, "Completed (crossover)", enrollment_status
  )))

demog$enrollment_status <- factor(demog$enrollment_status, levels = c("Enrolled (not screened yet)", "Lost to Follow-Up (before training)", "Screen failed", "Withdrawn (before training)",  "On-going Randomized", "Withdrawn (after training)", "Lost to Follow-Up (after training)", "Completed", "Completed (crossover)"))


ggplot(aes(x=enrollment_status, fill = enrollment_status, alpha=0.8), data=demog)+geom_bar(stat="count")+theme_bw()+
  ggtitle(paste("Total Participants: n=", sep="", length(unique(demog$record_id))))+ theme(plot.title = element_text(hjust = 0.5))+xlab("Participant Status")+ylab("Number")+scale_fill_discrete(name = "Group")+ theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+theme(legend.position = "none")+ geom_text(aes(label=..count..),stat='count',vjust=1.5)
```

### Number completed for Control, HIIT, MICT:

```{r progressstrata3, message=FALSE, warning=FALSE, echo=FALSE}
cohort<-demog %>% 
  filter(is.na(ep_vo2_max)==FALSE | record_id == 133)

completed_num<-cohort %>% 
  filter(is.na(ep_vo2_max)==FALSE & record_id <= 1000 | record_id == 133)

completed_num<-length(completed_num$record_id)

cohort %>% 
  filter(is.na(ep_vo2_max)==FALSE & record_id < 1000 | record_id ==133) %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+ theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste0(completed_num, sep=" ", "Completed with VO2 max pre/post")) + guides(alpha = "none")+scale_fill_viridis_d(option = "D")

```


## Workout Adherence
```{r, message=FALSE, warning=FALSE, echo=FALSE}

# If missing total num workouts (e.g. control or withdrew before training), impute as 0.
demog<-demog %>% 
  mutate(total_workouts_in_REDCap = ifelse(is.na(total_workouts_in_REDCap)==TRUE, 0, total_workouts_in_REDCap),
         quality_workouts_in_REDCap = ifelse(is.na(quality_workouts_in_REDCap)==TRUE, 0, quality_workouts_in_REDCap))
         

# Workout adherence stats
rand<-demog %>%
  filter(Group != "New Participant" & record_id <1000)
count<-length(rand$record_id)
demog %>%
  filter(Group != "New Participant" & record_id <1000) %>% 
  ggplot(aes(y = quality_workouts_in_REDCap, x=Group, group=Group, color=enrollment_status))+geom_boxplot(outlier.shape = NA)+geom_jitter(width=0.1, alpha=0.8)+theme_bw()+ggtitle(paste0("Quality wkts in REDCap: all randomized participants (n=", count, ")"))+theme(plot.title=element_text(hjust=0.5))+ylab("Quality workouts in REDCap (>50% in target HR zone)")

demog %>%
  filter(Group != "New Participant" & record_id <1000) %>% 
  ggplot(aes(y = total_workouts_in_REDCap, x=Group, group=Group, color=enrollment_status))+geom_boxplot(outlier.shape = NA)+geom_jitter(width=0.1, alpha=0.8)+theme_bw()+ggtitle(paste0("Total wkts in REDCap: all randomized participants (n=", count, ")"))+theme(plot.title=element_text(hjust=0.5))+ylab("Total workouts in REDCap logged")

```


## Rate of Perceived Exertion (RPE) 

The following plots show RPE for MICT and HIIT participants across workouts.
```{r, message=FALSE, warning=FALSE, echo=FALSE}
knitr::include_graphics("/Users/aubreykr/Desktop/rpe.png")
knitr::include_graphics("/Users/aubreykr/Desktop/rpe2.png")
```


## Flagged participants

Participant record IDs are labeled below if they completed <20 total workouts (graph 1) and/or <20 quality workouts (graph 2). Note, these participants w/ less than 20 workouts total (graph 1) were likely to be lost to follow-up or withdrew from the study meaning they also did not return for endpoint visits.

```{r adherencecolored, message=FALSE, warning=FALSE, echo=FALSE}

demog$EP_VO2 <- ifelse(demog$EP_VO2 == " ", "NO", demog$EP_VO2)
demog %>%
  filter(!Group %in% c( "New Participant", "Control") & record_id < 1000) %>% 
  ggplot(aes(y = total_workouts_in_REDCap, x=Group, group=Group, shape=EP_VO2)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(color = quality_workouts_in_REDCap), position = position_jitter(width = 0.15), size = 2) +
  theme_bw() +
  ggtitle(paste0("Flag if total num workouts < 20")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("Total workouts in REDCap logged") +
scale_color_gradient2(
  name = "Number of quality workouts",
  low = "red",
  mid = "yellow",
  high = "green",
  midpoint = 20
)+geom_hline(yintercept = 20, linetype="dashed")+ 
 geom_text_repel(
  data = function(d) d %>% filter(total_workouts_in_REDCap < 20),
  aes(label = paste0(record_id, "--", enrollment_status)),
  size = 2,
  label.size = 0.2
)+labs(shape="Endpoint VO2 complete?")


demog %>%
  filter(Group != "New Participant" & record_id < 1000 & Group != "Control") %>% 
  ggplot(aes(y = total_workouts_in_REDCap, x=Group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(aes(color = quality_workouts_in_REDCap), position = position_jitter(width = 0.15), size = 2) +
  theme_bw() +
  ggtitle("Flag if completed study, but num 'quality' workouts < 20") +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("Total workouts in REDCap logged") +
scale_color_gradient2(
  name = "Number of quality workouts",
  low = "red",
  mid = "yellow",
  high = "green",
  midpoint = 20
)+geom_hline(yintercept = 20, linetype="dashed")+ 
 geom_text_repel(
  data = function(d) d %>% filter(quality_workouts_in_REDCap < 20 & total_workouts_in_REDCap > 20),
  aes(label = paste0(record_id, "--", enrollment_status)),
  size = 2,
  label.size = 0.2
)


# demog %>%
#   filter(Group != "New Participant" & record_id < 1000 & Group != "Control") %>% 
#   ggplot(aes(y = total_workouts_in_REDCap, x=Group)) +
#   geom_boxplot(outlier.shape = NA) +
#   geom_point(aes(color = quality_workouts_in_REDCap), position = position_jitter(width = 0.15), size = 2) +
#   theme_bw() +
#   ggtitle("Flag if randomized, but no EP VO2 max") +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   ylab("Total workouts in REDCap logged") +
# scale_color_gradient2(
#   name = "Number of quality workouts",
#   low = "red",
#   mid = "yellow",
#   high = "green",
#   midpoint = 20
# )+geom_hline(yintercept = 20, linetype="dashed")+ 
#  geom_text_repel(
#   data = function(d) d %>% filter(EP_VO2 == "NO"),
#   aes(label = paste0(record_id, "--", enrollment_status)),
#   size = 2,
#   label.size = 0.2
# )

demog$ep_trainingtest_date_done<-ifelse(demog$ep_trainingtest_date_done==" ", "NO", demog$ep_trainingtest_date_done)


# demog %>%
#   filter(Group != "New Participant" & record_id < 1000 & Group != "Control") %>% 
#   ggplot(aes(y = total_workouts_in_REDCap, x=Group)) +
#   geom_boxplot(outlier.shape = NA) +
#   geom_point(aes(color = quality_workouts_in_REDCap), position = position_jitter(width = 0.15), size = 2) +
#   theme_bw() +
#   ggtitle("Flag if randomized, but no EP CTRU visit") +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   ylab("Total workouts in REDCap logged") +
# scale_color_gradient2(
#   name = "Number of quality workouts",
#   low = "red",
#   mid = "yellow",
#   high = "green",
#   midpoint = 20 g
# )+geom_hline(yintercept = 20, linetype="dashed")+ 
#  geom_text_repel(
#   data = function(d) d %>% filter(ep_trainingtest_date_done == "NO"),
#   aes(label = paste0(record_id, "--", enrollment_status)),
#   size = 2,
#   label.size = 0.2
# )
```

Only 7 participants (3 HIIT -- HR too low; 4 MICT -- HR too high) did not adhere to target HR zone in the majority of workouts.

```{r adherencecolored2, message=FALSE, warning=FALSE, echo=FALSE}


demog %>% 
  filter(Group !="Control" & enrollment_status == "Completed" & record_id <1000) %>% 
  mutate(`20_or_more_wkts` = ifelse(total_workouts_in_REDCap >=20, "yes", "no"),
         `20_or_more_wkts_in_zone` = ifelse(quality_workouts_in_REDCap >=20, "yes", "no")) %>% 
  group_by(Group, `20_or_more_wkts`, `20_or_more_wkts_in_zone`) %>% 
  count() %>% 
  kbl(align = "c", caption = "HIIT or MICT Participants (n=68): only ~7 participants did not adhere to HR zone") %>% 
   kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

# demog %>%
#   filter(Group !="New Participant" & record_id < 1000) %>%
#   group_by(Group, EP_VO2) %>%
#   count() %>%
#   arrange(desc(n)) %>%
#   kbl(col.names = c("Group", "EP VO2?", "n"), align = "c", caption = "Randomized participants (n=109): completion of EP VO2 test (n=89)") %>%
#    kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))
# 
# demog %>%
#   filter(Group !="New Participant" & record_id < 1000) %>%
#   group_by(Group, ep_trainingtest_date_done) %>%
#   count() %>%
#   arrange(desc(n)) %>%
#   kbl(col.names = c("Group", "EP CTRU?", "n"), align = "c", caption = "Randomized participants (n=109): completion of EP CTRU test (n=87)") %>%
#    kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

```


## Visit Counts

```{r visitcounts, message=FALSE, warning=FALSE, echo=FALSE}
demog %>%
  filter(Group !="New Participant" & record_id < 1000) %>%
  group_by(Group, enrollment_status, is.na(bl_vo2_max)==FALSE, is.na(bl_trainingtest_date)==FALSE,is.na(ep_vo2_max)==FALSE, is.na(ep_trainingtest_date)==FALSE) %>%
  summarize(n= n_distinct(record_id)) %>%
  arrange(desc(n)) %>%   
  kbl(col.names = c("Group", "Status", "BL VO2?", "BL CTRU?", "EP VO2?", "EP CTRU?", "n"), align = "c", caption = "Randomized participants (n=109): completion of visits") %>%
   kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

# demog %>%
#   filter(Group !="New Participant" & record_id > 1000) %>%
#   group_by(Group, enrollment_status, is.na(ep_vo2_max)==FALSE, is.na(ep_trainingtest_date)==FALSE) %>%
#   summarize(n= n_distinct(record_id)) %>%
#   arrange(desc(n)) %>%   
#   kbl(col.names = c("Group", "Status", "EP VO2?", "EP CTRU?", "n"), align = "c", caption = "Crossover participants (n=8): completion of visits") %>%
#    kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))
```

### VO2 max tests (count)

Note: the following tables do not include crossover participants. There were 8 crossover participants and therefore 8 more VO2 max tests (that occurred after the crossover). These are not accounted for here.

```{r vo2count, message=FALSE, warning=FALSE, echo=FALSE}

demog %>%
  filter(Group !="New Participant" & record_id < 1000) %>%
  group_by(Group, is.na(bl_vo2_max)==FALSE) %>% 
  summarize(n= n_distinct(record_id)) %>%
  arrange(desc(n)) %>%   
  kbl(col.names = c("Group", "BL VO2?", "n"), align = "c", caption = "Randomized participants (n=109): BL VO2 (n=109).") %>%
   kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

demog %>%
  filter(Group !="New Participant" & record_id < 1000) %>%
  group_by(Group, is.na(ep_vo2_max)==FALSE) %>% 
  summarize(n= n_distinct(record_id)) %>%
  arrange(desc(n)) %>%   
  kbl(col.names = c("Group", "EP VO2?", "n"), align = "c", caption = "Randomized participants (n=109): EP VO2 (n=89).") %>%
   kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

```

### Acute Exercise Visit (count)
```{r acutevisitcount, message=FALSE, warning=FALSE, echo=FALSE}

demog %>%
  filter(Group !="New Participant" & record_id < 1000) %>%
  group_by(Group, is.na(bl_trainingtest_date)==FALSE) %>% 
  summarize(n= n_distinct(record_id)) %>%
  arrange(desc(n)) %>%   
  kbl(col.names = c("Group", "BL CTRU?", "n"), align = "c", caption = "Randomized participants (n=109): BL Acute Ex Visit (n=102).") %>%
   kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))


demog %>%
  filter(Group !="New Participant" & record_id < 1000) %>%
  group_by(Group, is.na(ep_trainingtest_date)==FALSE) %>% 
  summarize(n= n_distinct(record_id)) %>%
  arrange(desc(n)) %>%   
  kbl(col.names = c("Group", "EP CTRU?", "n"), align = "c", caption = "Randomized participants (n=109): EP Acute Ex Visit (n=87).") %>%
   kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

  

```






## Crossover Participants

```{r crossovers, message=FALSE, warning=FALSE, echo=FALSE}

demog %>% 
  filter(crossover == "yes") %>% 
  ggplot(aes( x=strata, fill=Group)) + geom_bar(alpha=0.5) +
  geom_text(stat = "count", aes(label = paste0(record_id, sep="\n(", total_workouts_in_REDCap, sep=")"), y = ..count..),
            position = position_stack(vjust = 0.5), color = "black", size = 3, alpha=1) +
  scale_x_discrete(drop = FALSE) + theme_bw() +
  theme(axis.text.x = element_text(angle = 55, vjust = 1, hjust = 1)) +
  xlab(paste0("Plot Last Updated:", sep = " ", Sys.Date())) +
  ggtitle(paste0("Crossover Participants by Group (HIIT/MICT) x Strata (M, F; age group)")) + labs(fill = "Record ID") + theme(plot.title = element_text(hjust = 0.5)) +
  ylim(c(0,3))

```


```{r workouts3,message=FALSE, warning=FALSE, echo=FALSE}
### HIIT vs. MICT
#demog %>% 
#  filter(enrollment_status == "Completed" & Group %in% c("HIIT", "MICT")) %>% 
 # ggplot(aes(y=percent_complete_of_36_wkts, x=Group)) + geom_boxplot() + geom_point() + ylab("Percent Complete of 36 Workouts") +
 # ggtitle("Percent Complete of 36 Workouts by Randomization Group") + theme_bw()+ theme(plot.title = element_text(hjust = 0.5)) + ylim(c(0,100))

# 
# demog %>% 
#   filter(enrollment_status == "Completed" & Group %in% c("HIIT", "MICT")) %>% 
#   ggplot(aes(y=total_workouts_in_REDCap, x=Group)) + geom_boxplot() +geom_point() + geom_hline(yintercept = 32, linetype="dashed") + ylab("Total Workouts in REDCap") +
#   ggtitle("Completed Participants (n=30): Total Workouts") + theme_bw()+ theme(plot.title = element_text(hjust = 0.5)) + ylim(c(0,40))
# 
# demog %>% 
#   filter(enrollment_status == "Completed" & Group %in% c("HIIT", "MICT")) %>% 
#   ggplot(aes(y=quality_workouts_in_REDCap, x=Group)) + geom_boxplot() +geom_jitter(aes(color=factor(record_id))) + geom_hline(yintercept = 32, linetype="dashed") + ylab("Total Workouts in REDCap") +
#   ggtitle("Completed Participants (n=30): Good Workouts") + theme_bw()+ theme(plot.title = element_text(hjust = 0.5)) + ylim(c(0,40)) + labs(color="Participant Num")

```


## Participant Counts

### Progress toward filling 4 strata

```{r progressstrata, message=FALSE, warning=FALSE, echo=FALSE}

# Create sex + agebin variable
demog$strata[demog$sex == "Female" & demog$agegroup == "18-34 yrs"]<-"F, 18-35"
demog$strata[demog$sex == "Female" & demog$agegroup == "35-65 yrs"]<-"F, 35-65"
demog$strata[demog$sex == "Male" & demog$agegroup == "18-34 yrs"]<-"M, 18-34"
demog$strata[demog$sex == "Male" & demog$agegroup == "35-65 yrs"]<-"M, 35-64"


cohort<-demog %>% 
  filter(enrollment_status == "On-going Randomized" & record_id <1000 | enrollment_status == "Completed" & record_id <1000 | record_id == 107)

# cohort %>% 
#   filter(is.na(ep_vo2_max)==FALSE & record_id < 1000) %>% 
#   ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+theme_bw()+
#   theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
#   geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
#   ggtitle(paste0(completed_num, sep=" ", "Completed with CPX pre/post")) + guides(alpha = "none") + facet_wrap(~strata)

cohort %>% 
   filter(is.na(ep_vo2_max)==FALSE & record_id < 1000 | record_id ==133 | record_id ==107) %>% 
  ggplot(aes(x=sex, fill=sex, alpha=0.8))+geom_bar(stat="count")+theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste0(completed_num, sep=" ", "Completed with Study")) + guides(alpha = "none") + facet_wrap(~Group)


# Progress Toward Filling 4 Strata (M, F, 18-35 yrs, 35-55 yrs)

cohort %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+facet_wrap(~strata)+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste("On-going Randomized or Completed Study: n=", sep="", length(unique(cohort$record_id)))) + guides(alpha = "none")

cohort<-cohort %>% 
  filter(record_id != "81" & record_id !="69" & record_id !="1070" & record_id !="1076" & record_id !="1091" & record_id != "1125")

cohort %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+ theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste("Sum of on-going + completed: n=", sep="", length(unique(cohort$record_id)))) + guides(alpha = "none")


test<-demog %>% 
   filter(is.na(ep_vo2_max)==FALSE | enrollment_status=="On-going Randomized"| record_id > 1000) %>% 
  select(record_id)
counting<-length(test$record_id)
  
demog %>% 
   filter(is.na(ep_vo2_max)==FALSE | enrollment_status=="On-going Randomized"| record_id > 1000) %>% 
  ggplot(aes(x=Group, fill=Group,alpha=0.8))+geom_bar(stat="count")+ theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste("Sum of on-going + completed (WITH CROSSOVERS): n=", sep="", length(unique(test$record_id)))) + guides(alpha = "none")
```

### ALL PARTICIPANTS RANDOMIZED

```{r progressstrata2, message=FALSE, warning=FALSE, echo=FALSE}

randomized<-demog %>% 
  filter(Group != "New Participant")

randomized_exclude_crossover<-demog %>% 
  filter(Group != "New Participant" & record_id < 1000)

num_rand<-length(randomized$record_id)
num_rand_no_cross<-length(randomized_exclude_crossover$record_id)

randomized %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+ theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste0(num_rand, sep=" ", "were randomized (including crossovers)")) + guides(alpha = "none")

randomized_exclude_crossover %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+ theme_bw()+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste0(num_rand_no_cross, sep=" ", "were randomized (excluding crossovers)")) + guides(alpha = "none")


withdraw<-demog %>% 
  filter(Group != "New Participant" & enrollment_status != "On-going Randomized" & enrollment_status != "Completed")

```


### NUMBER CONSENTED

```{r consented, echo=FALSE, message=FALSE, warning=FALSE}
# PLOT CONSENTING
demog$date_consent<-as.yearmon(demog$date_consent)
demog$date_consent <- as.factor(demog$date_consent)
demog$date_consent<-factor(demog$date_consent, levels=c("Feb 2023", "Mar 2023", "Apr 2023", "May 2023", "Jun 2023", "Jul 2023", "Aug 2023", "Sep 2023", "Oct 2023", "Nov 2023", "Dec 2023", "Jan 2024", "Feb 2024", "Mar 2024", "Apr 2024", "May 2024", "Jun 2024", "Jul 2024", "Aug 2024", "Sep 2024", "Oct 2024", "Nov 2024", "Dec 2024", "Jan 2025", "Feb 2025", "Mar 2025", "April 2025", "May 2025", "Jun 2025", "Jul 2025", "Aug 2025"))

consent<-demog %>% 
  filter(is.na(date_consent)==FALSE)
consented_num<-length(consent$record_id)

demog %>% 
  filter(is.na(date_consent)==FALSE) %>% 
  ggplot(aes(x=date_consent)) + geom_bar(color="purple")+stat_count(geom = "text", color="white", aes(label = ..count..), vjust = 2)+theme_bw()+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + ggtitle(paste0("Number consented:", sep=" ", consented_num)) + theme(plot.title = element_text(hjust=0.5))+
  scale_y_continuous(breaks = seq(0,15,by=2)) + xlab("Month Consented")

```

## Month-by-Month Enrollment

Note: average counts exclude the first month and Dec 2023 for winter closure which had lower rates.

```{r formatdates, echo=FALSE, message=FALSE, warning=FALSE}

# Filter for relevant variables: start and end month, rand group, record_id
projected <- demog  %>% 
  filter(enrollment_status %in% c("Completed", "On-going Randomized")) %>% 
  dplyr::select(record_id, Group, start_month, end_month)

# Specify order of months
projected$start_month<-as.factor(projected$start_month)
projected$end_month<-as.factor(projected$end_month)

projected$start_month<-factor(projected$start_month, levels=c("Apr 2023", "May 2023", "Jun 2023", "Jul 2023", "Aug 2023", "Sep 2023", "Oct 2023", "Nov 2023", "Dec 2023", "Jan 2024", "Feb 2024", "Mar 2024", "Apr 2024", "May 2024", "Jun 2024", "Jul 2024", "Aug 2024", "Sep 2024", "Oct 2024", "Nov 2024", "Dec 2024", "Jan 2025", "Feb 2025", "Mar 2025", "Apr 2025", "May 2025",  "Jun 2025", "Jul 2025", "Aug 2025"))

projected$end_month<-factor(projected$end_month, levels=c("Apr 2023", "May 2023", "Jun 2023", "Jul 2023", "Aug 2023", "Sep 2023", "Oct 2023", "Nov 2023", "Dec 2023", "Jan 2024", "Feb 2024", "Mar 2024", "Apr 2024", "May 2024", "Jun 2024", "Jul 2024", "Aug 2024", "Sep 2024", "Oct 2024", "Nov 2024", "Dec 2024", "Jan 2025", "Feb 2025", "Mar 2025", "Apr 2025", "May 2025",  "Jun 2025", "Jul 2025", "Aug 2025"))

projected$start_month[is.na(projected$start_month)]<-"Apr 2025"
projected$end_month[is.na(projected$end_month)]<-"Jul 2025"
```

```{r plotprojected, echo=FALSE, message=FALSE, warning=FALSE}

# Plots
current_date <- Sys.Date()
current_date <- as.yearmon(current_date)
current_date <- as.factor(current_date)

counts_start<-projected %>% 
  group_by(start_month) %>% 
  count()
counts_start<-counts_start %>% 
  filter(!start_month %in% c("Apr 2023", "Apr 2025"))
avg_start <- round(mean(counts_start$n),2)

counts_end<-projected %>% 
  group_by(end_month) %>% 
  count()
counts_end<-counts_end %>% 
  filter(!end_month %in% c("Aug 2023", "Jul 2025"))
avg_end <- round(mean(counts_end$n),2)


projected %>% 
  ggplot(aes(x=start_month)) + geom_bar(fill="#F8766D") + stat_count(geom = "text", color="white", aes(label = ..count..), vjust = 2) +theme_bw()+
  ggtitle(paste0("Start Months, average count/month:", sep=" ", avg_start)) + theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = current_date, linetype="dotted", color="black")+ theme(axis.text.x = element_text(angle = 55, vjust = 1, hjust = 1)) 

projected %>% 
  ggplot(aes(x=end_month)) + geom_bar(fill="#00BFC4") + stat_count(geom = "text", color="white", aes(label = ..count..), vjust = 2) +theme_bw()+
  ggtitle(paste0("End Months, average count/month:", sep=" ", avg_end)) + theme(plot.title = element_text(hjust = 0.5))+ geom_vline(xintercept = current_date, linetype="dotted", color="black") + theme(axis.text.x = element_text(angle = 55, vjust = 1, hjust = 1)) 

# Combined start + end plot

num_projected <- length(unique(projected$record_id))

# Gather and color by timepoint
projected <- gather(projected, key = "Timepoint", value = "Month", c("start_month", "end_month"))
projected$Timepoint <- factor(projected$Timepoint, levels=c("start_month", "end_month"))
projected$Month<-factor(projected$Month, levels=c("Apr 2023", "May 2023", "Jun 2023", "Jul 2023", "Aug 2023", "Sep 2023", "Oct 2023", "Nov 2023", "Dec 2023", "Jan 2024", "Feb 2024", "Mar 2024", "Apr 2024", "May 2024", "Jun 2024", "Jul 2024", "Aug 2024", "Sep 2024", "Oct 2024", "Nov 2024", "Dec 2024", "Jan 2025", "Feb 2025", "Mar 2025", "Apr 2025", "May 2025",  "Jun 2025", "Jul 2025", "Aug 2025"))

ggplot(aes(x=Month, fill=Timepoint), data=projected) + geom_bar() + theme_bw()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle(paste0(num_projected, sep=" ", "completing the study by the last date plotted")) + theme(plot.title = element_text(hjust = 0.5))+ geom_vline(xintercept = current_date, linetype="dotted", color="black") + stat_count(geom = "text", color="white", aes(label = ..count..), vjust = 2) + scale_y_continuous(breaks = seq(0,20,by=2))  +theme(axis.text.x = element_text(angle = 55, vjust = 1, hjust = 1)) 

```

```{r, echo=FALSE, include=FALSE}

make_table <- function(data){
  # Simplify race categories
  data$race[data$race == "Other Asian - please specify below (Hmong, Laotian, Thai, Pakistani, Cambodian, etc)"] <- "Other"
  data$race <- as.factor(fct_infreq(data$race))

  # Simplify ethnicity categories
  data$ethnicity[data$ethnicity == "Yes, another Hispanic, Latino, or Spanish origin (please specify origin - Argentinean, Colombian, Dominical, Nicaraguan, Salvadoran, Spaniard, etc.)"] <- "Yes"
  data$ethnicity[data$ethnicity == "Yes, Mexican, Mexican American, Chicano"] <- "Yes"
  data$ethnicity[data$ethnicity == "No, not of Hispanic, Latino, or Spanish origin"] <- "No"
  data$ethnicity <- as.factor(fct_infreq(data$ethnicity))

  # Specify labels
  label(data$Group) <- "Randomization Group"
  label(data$sex) <- "Sex"
  label(data$agegroup) <- "Age Group"
  label(data$race) <- "Race"
  label(data$bl_vo2_max) <- "VO2 max"
  label(data$bl_bmi) <- "BMI"
  label(data$age) <- "Age"
  label(data$bl_percent_body_fat) <- "Body Fat"
  label(data$quality_workouts_in_REDCap) <- "Workouts Completed"
  label(data$percent_complete_of_36_wkts) <- "Workouts Completed"
  label(data$ethnicity) <- "Hispanic"

  # Specify units
  units(data$age) <- "years"
  units(data$bl_vo2_max) <- "mL/kg*min"
  units(data$bl_bmi) <- "kg/m2"
  units(data$bl_percent_body_fat) <- "%"
  units(data$quality_workouts_in_REDCap) <- "%"
  units(data$percent_complete_of_36_wkts) <- "%"

  # Define custom renderer for continuous variables
  my.render.cont <- function(x) {
    with(stats.default(x), sprintf("%0.1f (%0.1f)", MEAN, SD))
  }
  
pvalue <- function(x, ...) {
  y <- unlist(x)
  g <- factor(rep(1:length(x), times=sapply(x, length)))

  if (is.numeric(y)) {
    # Use ANOVA for >2 group comparison
    p <- summary(aov(y ~ g))[[1]][["Pr(>F)"]][1]
  } else {
    # Categorical variable: chi-squared test
    p <- chisq.test(table(y, g))$p.value
  }

  # Format the p-value
  if (is.na(p)) {
    return("")
  } else if (p < 0.001) {
    return("<0.001**")
  } else if (p < 0.05) {
    return("<0.05*")
  } else {
    return(sprintf("%.2f", p))
  }
}


  # Count the number of records
  count <- length(data$record_id)

  # Generate Table 1
  return(table1(
    ~ sex+ age + bl_vo2_max + race+ ethnicity |Group,
    render.continuous = my.render.cont,
    render.missing = NULL,
    caption = paste0(
      "Table 1. Baseline Demographics of Participants (n=",
      count,
      ")"
    ),
      #extra.col=list(`P-value`=pvalue),
    data = data
  ))

}


demog %>% 
  filter(bl_VO2 == "Yes") %>% 
  filter(Group !="New Participant" & Group !="Control") %>% 
  make_table() 


demog %>% 
  filter(enrollment_status %in% c("Completed")) %>% 
  make_table()

demog %>% 
  filter(enrollment_status %in% c("Completed", "On-going Randomized") & record_id <1000 | record_id ==154)  %>% 
  make_table()

demog %>% 
  filter(enrollment_status %in% c("Completed", "On-going Randomized") | record_id > 1000) %>% 
  make_table()

demog %>% 
  filter(enrollment_status %in% c("Completed", "On-going Randomized", "Enrolled (not screened yet)") & record_id !=1125 & record_id !="138") %>% 
  make_table()

demog %>% 
   filter(is.na(ep_vo2_max)==FALSE | enrollment_status=="On-going Randomized"| record_id > 1000) %>% 
  make_table()
demog %>% 
  filter(enrollment_status %in% c("Completed", "On-going Randomized", "Enrolled (not screened yet)") | record_id>1000) %>% 
  make_table()

demog
# Randomized Participants
randomized_exclude_crossover %>% 
  make_table()

randomized %>% 
  make_table()

withdraw %>% 
  make_table()

# Completed participants
cohort %>%
  filter((is.na(ep_vo2_max)==FALSE & record_id < 1000) | record_id == 154) %>%
  make_table()

# Projected Participants
cohort %>%
  make_table()

cohort %>%
  ggplot(aes(y=age, x=sex))+geom_violin()+geom_jitter(width = 0.2)+facet_wrap(~agegroup)

cohort %>%
  ggplot(aes(y=age, x=sex))+geom_violin()+geom_jitter(width = 0.2, aes(color=agegroup))

cohort %>%
  ggplot(aes(y=age, x=sex))+geom_violin()+geom_jitter(width = 0.2)+ggtitle("Age for Females vs. Males")

cohort %>%
  ggplot(aes(x=age, color=sex))+theme_bw()+geom_density()+ggtitle("Age for Females vs. Males")+theme(plot.title=element_text(hjust=0.5))

cohort %>%
  ggplot(aes(y=bl_vo2_max, x=Group, color=Group))+theme_bw()+geom_boxplot()+ggtitle("Baseline VO2 Max across Groups")+theme(plot.title=element_text(hjust=0.5))+geom_jitter(width=0.2)

cohort %>%
  ggplot(aes(y=bl_bmi, x=Group, color=Group))+theme_bw()+geom_boxplot()+ggtitle("Baseline BMI across Groups")+theme(plot.title=element_text(hjust=0.5))+geom_jitter(width=0.2)

cohort %>%
  ggplot(aes(y=age, x=Group, color=Group))+theme_bw()+geom_boxplot()+ggtitle("Age across Groups")+theme(plot.title=element_text(hjust=0.5))+geom_jitter(width=0.2)


cohort %>%
  ggplot(aes(y=age, x=sex, color=sex))+theme_bw()+geom_boxplot()+ggtitle("Age by sex")+theme(plot.title=element_text(hjust=0.5))+geom_jitter(width=0.2)


cohort %>%
  ggplot(aes(x=Group, fill=race))+theme_bw()+geom_bar(position="dodge")+ggtitle("Race across groups")+theme(plot.title=element_text(hjust=0.5))+ylab("Proportion")


cohort %>%
  group_by(sex, agegroup) %>%
  count()

cohort %>%
  group_by(sex, agegroup) %>%
  summarize(mean(age),
            sd(age))

cohort %>%
  group_by(sex) %>%
  summarize(mean(age),
            sd(age))

demog %>% 
  group_by(enrollment_status) %>% 
  count()

demog %>% 
  filter(Group !="New Participant" & record_id < 1000) %>% 
  group_by(Group) %>% 
  count()


demog %>% 
  filter(Group != "New Participant") %>% 
  group_by(Group, enrollment_status) %>% 
  count()

demog %>% 
  group_by(enrollment_status,Group) %>% 
  count()


demog %>% 
  filter(record_id < 1000) %>% 
  group_by(Group, enrollment_status) %>% 
  count()


demog %>% 
  filter(Group =="New Participant" & record_id < 1000) %>% 
  group_by(enrollment_status) %>% 
  count()

```


## Age of Cohort
```{r codehere,message=FALSE, warning=FALSE, echo=FALSE}

demog %>% 
  filter(enrollment_status %in% c("Completed", "On-going Randomized")) %>% 
  ggplot(aes(x=Group, y=age))+geom_boxplot()+geom_jitter()+theme_bw()+ggtitle("Age for All Participants (n=94)")+facet_wrap(~sex)

```




## Biopsy Tracker

```{r biopsy, message=FALSE, warning=FALSE, echo=FALSE}

# demog$baseline_visit_biopsy_complete <- ifelse(demog$baseline_visit_biopsy_complete=="Complete", 1, 0)
# demog$endpoint_visit_biopsy_complete <- ifelse(demog$endpoint_visit_biopsy_complete=="Complete", 1, 0)
# 
# biopsy<-demog %>% 
#   filter(baseline_visit_biopsy_complete == 1 | endpoint_visit_biopsy_complete == 1) %>% 
#   gather(key = "Timepoint", value="biopsy_completed", c("baseline_visit_biopsy_complete", "endpoint_visit_biopsy_complete"))
# 
# biopsy<-biopsy %>% 
#   dplyr::select(record_id, enrollment_status, sex, agegroup, Group, Timepoint, biopsy_completed) %>% 
#   mutate(Timepoint = ifelse(Timepoint=="baseline_visit_biopsy_complete", "Baseline", "Endpoint"))
# 
# biopsy$Group[biopsy$record_id == 1076] <- "MICT"
# 
# biopsy %>% 
#   filter(biopsy_completed==1) %>% 
#   group_by(Group, Timepoint) %>% 
#   count() %>% 
#   kable() %>% 
#   kable_styling(full_width = FALSE)
# 
# biopsy %>% 
#   filter(biopsy_completed==1) %>% 
#   ggplot(aes(x=Group, fill=Timepoint))+geom_bar() + theme_bw() + ggtitle("Biopsies completed") + theme(plot.title=element_text(hjust=0.5)) + scale_y_continuous(n.breaks=10)
# 
# biopsy %>% 
#   filter(biopsy_completed==1) %>% 
#   arrange(Group, record_id) %>% 
#   dplyr::select(record_id, Group, Timepoint) %>% 
#   kable() %>% 
#   kable_styling(full_width = FALSE)

# biopsy %>% 
#   filter(biopsy_completed==1) %>% 
#   ggplot(aes(x=Group, fill=Timepoint))+geom_bar(position="dodge") + theme_bw() + ylim(c(0,5)) + ggtitle("Number of biopsies complete") + theme(plot.title = element_text(hjust = 0.5))

# Recode for adipose, muscle biopsy
demog$bl_muscle <- ifelse(demog$bl_muscle=="Yes", 1, 0)
demog$ep_muscle <- ifelse(demog$ep_muscle=="Yes", 1, 0)
demog$bl_adipose <- ifelse(demog$bl_adipose=="Yes", 1, 0)
demog$ep_adipose <- ifelse(demog$ep_adipose=="Yes", 1, 0)


biop_for_jessi<-demog %>% 
  select(record_id, Group,  bl_muscle, bl_adipose, ep_muscle, ep_adipose) %>% 
  filter(is.na(bl_adipose) !=TRUE)

write.csv(biop_for_jessi, "/Users/aubreykr/Desktop/biopsylist.csv")

# Format muscle df
muscle_df<-demog %>% 
  select(record_id, sex, Group, bl_muscle, ep_muscle, sex) %>% 
  filter(is.na(bl_muscle)==FALSE)

muscle_df<-muscle_df %>% 
  gather(key="Timepoint", value="Completed", c(bl_muscle, ep_muscle)) %>% 
  mutate(Timepoint = ifelse(Timepoint=="bl_muscle", "Baseline", "Endpoint"))

# Format adipose df
adipose_df<-demog %>% 
  select(record_id, sex, Group, bl_adipose, ep_adipose) %>% 
  filter(is.na(bl_adipose)==FALSE)

adipose_df<-adipose_df %>% 
  gather(key="Timepoint", value="Completed", c(bl_adipose, ep_adipose)) %>% 
  mutate(Timepoint = ifelse(Timepoint=="bl_adipose", "Baseline", "Endpoint"))

# Plots
muscle_df %>% 
  filter(Completed == 1) %>% 
  ggplot(aes(x=Timepoint, fill=Group)) + geom_bar() +theme_bw() + theme(plot.title=element_text(hjust=0.5)) + ggtitle("Muscle biopsies completed") + geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5)) + ylim(c(0,20))+scale_fill_brewer(palette = "Dark1")

muscle_df %>% 
  filter(Completed == 1) %>% 
  ggplot(aes(x=Timepoint, fill=Group)) + geom_bar() +theme_bw() + theme(plot.title=element_text(hjust=0.5)) + ggtitle("Muscle biopsies completed") + geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5)) + ylim(c(0,20))+facet_wrap(~sex)+scale_fill_brewer(palette = "Dark1")

adipose_df %>% 
  filter(Completed == 1) %>% 
  ggplot(aes(x=Timepoint, fill=Group, group=Group)) + geom_bar()+theme_bw()+  theme(plot.title=element_text(hjust=0.5)) + ggtitle("Adipose biopsies completed")+ geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5)) + ylim(c(0,20))+scale_fill_brewer(palette = "Dark1")
adipose_df %>% 
  filter(Completed == 1) %>% 
  ggplot(aes(x=Timepoint, fill=Group, group=Group)) + geom_bar()+theme_bw()+  theme(plot.title=element_text(hjust=0.5)) + ggtitle("Adipose biopsies completed")+ geom_text(stat = "count", aes(label = ..count..), position = position_stack(vjust = 0.5)) + ylim(c(0,20))+facet_wrap(~sex)+scale_fill_brewer(palette = "Dark1")

```



## Workout Leaderboard

Participants are sorted by # quality workouts.
Quality workouts = majority of workout in target heart rate zone, scored by RAs + Aubrey.
```{r message=FALSE, warning=FALSE, echo=FALSE}

demog$bl_adipose<-ifelse(is.na(demog$bl_adipose)==TRUE, "", demog$bl_adipose)
demog$bl_muscle<-ifelse(is.na(demog$bl_muscle)==TRUE, "", demog$bl_muscle)
demog$ep_adipose<-ifelse(is.na(demog$ep_adipose)==TRUE, "", demog$ep_adipose)
demog$ep_muscle<-ifelse(is.na(demog$ep_muscle)==TRUE, "", demog$ep_muscle)


# Filter for participants who are on-going
demog %>%
  filter(Group %in% c("HIIT", "MICT", "Control")) %>% 
  arrange(enrollment_status) %>% 
  dplyr::select(record_id, enrollment_status, Group, total_workouts_in_REDCap, quality_workouts_in_REDCap, mean_rpe, sd_rpe, EP_surveys, EP_VO2, ep_trainingtest_date_done, bl_muscle, bl_adipose, ep_muscle, ep_adipose) %>% 
  arrange(desc(quality_workouts_in_REDCap), enrollment_status) %>% 
  kbl(col.names = c("Record ID","Status","Group", "Total Wkts", "Quality Wkts", "RPE (mean)", "RPE (sd)", "EP surveys?", "EP_Vo2?", "EP_CTRU?", "bl_muscle?", "bl_adipose?", "ep_muscle?", "ep_adipose?"), align="c", escape=FALSE, caption=paste0("All randomized participants:")) %>%
  kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

```


```{r wearables, message=FALSE, warning=FALSE, echo=FALSE}
## Workout Tracking: Wearables vs. REDCap

## PROCESSING DATA FROM GOOGLE DRIVE ##
# Read in wearable data from Google Drive
#data<-read.csv("/Users/aubreykr/Library/CloudStorage/GoogleDrive-aubreykr@stanford.edu/Shared drives/HIIT and Endurance 3Study/Data/data/workout/workout_allevents.csv")

# Rename to record_id and place at front of dataset
# data<-data %>% 
#   dplyr::rename(record_id = ppt_id) %>% 
#   dplyr::select(record_id, everything())
# 
# # Create date 
# data<-data %>% 
#   mutate(date = as.Date(data$X_realtime))

# Unique participants in the dataset
#length(unique(data$date))
#length(unique(data$record_id))
#(unique(data$sourcetype))
#paste0("Participants in this dataset:", sep=" ", (list(unique(data$record_id))))

# COUNT POLAR WORKOUTS
# Count number of polar workouts
# data_polar<-data %>% 
#   filter(sourcetype == "WearablePolar") %>% 
#   group_by(record_id, date) %>% 
#   count()
# 
# # Create num minutes per workout column
# data_polar$polar_minutes = data_polar$n/60
# 
# # COUNT FITBIT WORKOUTS
# # Count number of fitbit workouts
# data_fitbit<-data %>% 
#   filter(sourcetype == "WearableFitbit") %>% 
#   group_by(record_id, date) %>% 
#   count()
# 
# # Create num minutes per workout column
# data_fitbit$fitbit_minutes = data_fitbit$n/60
# 
# # remove n column
# data_polar<-data_polar %>% 
#  dplyr::select(-c(n))
# data_fitbit<-data_fitbit %>% 
#   dplyr::select(-c(n))
# 
# # MERGE WEARABLE DATA
# 
# # Merge polar and fitbit dataframes
# summary<-full_join(data_polar, data_fitbit, by=c("record_id", "date"))
# 
# # Total number workouts for Polar, Fitbit
# num_polar_workouts <- summary %>% 
#  filter(is.na(polar_minutes)!=TRUE) %>% 
#  group_by(record_id) %>% 
#  summarize(wearable_polar_workouts = length(unique(date)))
# 
# num_fitbit_workouts <- summary %>% 
#  filter(is.na(fitbit_minutes)!=TRUE) %>% 
#  group_by(record_id) %>% 
#  summarize(wearable_fitbit_workouts = length(unique(date)))
# 
# # SUMMARIZE NUMBER WORKOUTS
# #num_polar_workouts
# #num_fitbit_workouts
# 
# wearables<-full_join(num_polar_workouts, num_fitbit_workouts, by="record_id")
```

```{r wearable merging, messages=FALSE, warning=FALSE, echo=FALSE}

## JOIN MYPHD/POLAR DATA WITH DEMOG FRAME ##

# demog<-full_join(demog, wearables, by="record_id")
# 
# # calculate num missing
# demog$num_missing_polar <- demog$wearable_polar_workouts - demog$number_polar_used
# demog$num_missing_fitbit <- demog$wearable_fitbit_workouts - demog$number_fitbit_used
# 
# # set up data for table
# completed<-demog %>% 
#   filter(enrollment_status == "Completed" & Group != "Control") %>% 
#   dplyr::select(record_id, number_polar_used, wearable_polar_workouts, num_missing_polar, number_fitbit_used, wearable_fitbit_workouts, num_missing_fitbit)
# 
# # create table
# completed %>% 
#     arrange(as.numeric(record_id)) %>% 
#   kable(col.names = c("Record ID", "REDCap polar", "Wearable polar", "Num missing polar", "REDCap fitbit", "Wearable fitbit", "Num missing fitbit"), align="c") %>%
#    kable_styling(full_width = F, position = "center", font_size = 14, latex_options = "striped", bootstrap_options = c("striped", "hover"))

```

*Thanks everybody for your hard work!*

```{r vo2 analysis,  echo=FALSE, include=FALSE, message=FALSE}
# vo2 <- gather(demog, key="Timepoint", value="VO2_Max", c(bl_vo2_max, ep_vo2_max))
# vo2$Timepoint[vo2$Timepoint == "bl_vo2_max"] <- "Week 0"
# vo2$Timepoint[vo2$Timepoint == "ep_vo2_max"] <- "Week 12"
# 
# vo2 %>% 
#   filter(Group %in% c("HIIT", "MICT") & enrollment_status == "Completed") %>% 
#   ggplot(aes(x=Timepoint, y=VO2_Max)) + geom_boxplot() + geom_point()+
#   labs(title = "VO2: Baseline vs. Endpoint", x = "Timepoint", y = "VO2 Peak (mL/kg)") + facet_wrap(~Group)+
#   theme(plot.title=element_text(hjust=0.5)) + stat_compare_means(method = "t.test",
#                                                                  label = "p.format",
#                                                                  paired = TRUE)
# # percent change
# demog$vo2change <- (demog$ep_vo2_max - demog$bl_vo2_max) / demog$bl_vo2_max * 100
# demog$bmi_change <- demog$ep_bmi - demog$bl_bmi
# demog$bodyfatchange <- demog$ep_percent_body_fat - demog$bl_percent_body_fat 
# 
# demog %>% 
#   filter(enrollment_status == "Completed" & record_id != 4) %>% 
#   group_by(Group) %>% 
#   summarize(mean = mean(vo2change),
#             sd = sd(vo2change))
# 
# 
# demog %>% 
#   filter(enrollment_status == "Completed" & record_id !="4") %>% 
#   ggplot(aes(y=vo2change, x=Group, color=sex, group=Group)) + geom_boxplot() + geom_point()+ theme_bw()+
#   labs(title = "VO2 Max: Baseline vs. Endpoint", x = "Group", y = "% change in VO2 Max") + 
#   theme(plot.title=element_text(hjust=0.5)) + stat_compare_means(method = "t.test",
#                                                                  label = "p.format",
#                                                                  paired = TRUE) + 
#   geom_hline(yintercept = 0, linetype="dashed") + labs(color="Sex")
# colnames(demog)

```

```{r testdata, echo=FALSE, include=FALSE, message=FALSE, warning=FALSE}

# save<-demog %>% 
#  filter(enrollment_status == "Completed") 
# 
# label(save$Group) <- "Randomization Group"
# label(save$sex)  <- "Sex"
# label(save$agegroup)  <- "Age Group"
# label(save$race) <- "Race"
# label(save$vo2change) <- "VO2 max"
# label(save$bmi_change) <- "BMI "
# label(save$bodyfatchange) <- "Body Fat"
# label(save$quality_workouts_in_REDCap) <- "Workouts Completed"
# units(save$vo2change)       <- "%"
# units(save$bmi_change) <- "kg/m2"
# units(save$bodyfatchange) <- "%"
# units(save$quality_workouts_in_REDCap) <- "%"
# 
# my.render.cont <- function(x) {
#    with(stats.default(x), 
#        sprintf("%0.2f (%0.1f)", MEAN, SD))
# }
#   
# #table1(~sex + agegroup + vo2change + bmi_change + bodyfatchange + I(quality_workouts_in_REDCap/32 * 100) | Group, overall=F,
#      #    render.continuous=my.render.cont, render.missing=NULL, caption="Table 1. Participant Demographics and Preliminary Findings", data=save)
# 
# 
# # another table 1 version
# save<-demog %>% 
#   filter(enrollment_status == "Completed")
# 
# label(save$Group) <- "Randomization Group"
# label(save$sex)  <- "Sex"
# label(save$agegroup)  <- "Age Group"
# label(save$race) <- "Race"
# label(save$vo2change) <- "VO2 max"
# label(save$bmi_change) <- "BMI "
# label(save$bodyfatchange) <- "Body Fat"
# label(save$quality_workouts_in_REDCap) <- "Workouts Completed"
# units(save$vo2change)       <- "%"
# units(save$bmi_change) <- "kg/m2"
# units(save$bodyfatchange) <- "%"
# units(save$quality_workouts_in_REDCap) <- "%"
# 
# save$race[save$race == "Other Asian - please specify below (Hmong, Laotian, Thai, Pakistani, Cambodian, etc)"] <- "Other"
# table1(~sex + agegroup + race + Group,
#          render.continuous=my.render.cont, render.missing=NULL, caption="Table 1. Participant Demographics", data=save)
# 



```



```{r scoringefficacy, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}

# motiv<-read.csv("/Users/aubreykr/Desktop/exselfefficacy.csv")
# 
# motiv<-motiv %>% 
#   rename(Timepoint = redcap_event_name) %>% 
#   dplyr::select(-c(exeffiency_date_enrolled, exercise_selfefficacy_complete)) %>% 
#   mutate(Timepoint = case_when(Timepoint == "scr_bl_ep_arm_1" ~ "Baseline",
#                                Timepoint == "week_12_ep_surveys_arm_1" ~ "Endpoint",
#                                Timepoint == "month_6_arm_1" ~ "Month 6"))
# 
# # self-efficacy score ranges from 9-28; sum the 9 questions.
# motiv$efficacy_score <- rowSums(motiv[, 3:11])
# 
# # combine efficacy with vo2 data
# motiv<-motiv %>% 
#   dplyr::select(record_id, Timepoint, efficacy_score)
#  
# motiv$record_id <- as.numeric(motiv$record_id)
# 
# vo2<-left_join(vo2, motiv, by=c("record_id", "Timepoint"))
# 
# vo2 %>% 
#   filter(record_id != "8" & record_id != "10" & record_id != "29") %>% 
#   ggplot(aes(x=Timepoint, y=efficacy_score)) + geom_boxplot() + geom_point()+
#   labs(title = "Exercise Self-Efficacy: Baseline vs. Endpoint", x = "Timepoint", y = "Exercise Self-Efficacy (Score 9-36)") + facet_wrap(~group) +
#   theme(plot.title=element_text(hjust=0.5)) + stat_compare_means(
#   method = "t.test", # You can also use "wilcox.test" for non-parametric test
#   label = "p.format",
#   paired = TRUE
# )
# 
# vo2 %>% 
#   filter(record_id != "8" & record_id != "10" & record_id != "29") %>% 
#   ggplot(aes(x=Timepoint, y=efficacy_score, group=group, color=factor(record_id))) + geom_point()  + geom_line(aes(group = record_id), linetype = "dashed") + facet_wrap(~group)
# 
# # plot VO2 max at BL vs. EP
# #ggplot(aes(x=Timepoint, y=VO2_Peak_mLkg, color=factor(record_id), group=record_id), data=vo2) + geom_point() +
#  # geom_line(aes(group = record_id), linetype = "dashed") +
#  # labs(title = "VO2 Peak: Baseline vs. Endpoint", x = "Timepoint", y = "VO2 Peak (mL/kg)") + facet_wrap(~group) + theme(plot.title=element_text(hjust=0.5))
# 
# # make demographics tables
# demog<-vo2 %>% 
#   filter(Timepoint == "Baseline")
# 
# label(demog$sex) <- "Sex"
# label(demog$agegroup) <- "Age Group"
# table1(~sex + agegroup | group, data=demog, overall=F, caption="Demographics for Completed Participants")
```

```{r test, echo=FALSE}
# Run a shiny app
# library(ggplot2)
# library(shiny)
# library(DT)
# 
# # Server
# server <- function(input, output) {
#   # Filter data based on selections
#   output$table <- DT::renderDataTable({
#     data <- completed_mict
#     datatable(data, options = list(rownames = FALSE))
#   })
# }
# 
# # UI
# ui <- fluidPage(
#   titlePanel("Basic DataTable"),
#   # Create a new row for the table.
#   DT::dataTableOutput("table")
# )
# 
# shinyApp(ui, server)

```
