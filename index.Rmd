---
title: "Study Progress"
output: 
  html_document:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
---

### HIIT vs. MICT 
This is designed to track study progress! Below is a weekly update.

```{r setup, include=FALSE}
# Load packages
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(table1)
library(lubridate)
library(shiny)
library(knitr)
library(kableExtra)
```


```{r demog, message=FALSE, warning=FALSE, echo=FALSE}
demog<-read.csv("/Users/aubreykr/Desktop/demog.csv")
```


### Study Progress
```{r plots, message=FALSE, warning=FALSE, echo=FALSE}

# if missing, they have enrolled and update this
demog$enrollment_status[is.na(demog$enrollment_status) == TRUE] <- "Enrolled (not screened yet)"

# Order levels of enrollment status
demog$enrollment_status <- factor(demog$enrollment_status, levels = c("Enrolled (not screened yet)", "Screen failed", "Lost to Follow-Up", "On-going Randomized", "Withdrawn", "Completed"))

ggplot(aes(x=enrollment_status, fill = enrollment_status, alpha=0.8), data=demog)+geom_bar(stat="count")+
  ggtitle(paste("Total Participants: n=", sep="", length(unique(demog$record_id)))) + theme(plot.title = element_text(hjust = 0.5))+xlab("Participant Status")+ylab("Number")+scale_fill_discrete(name = "Group")+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+theme(legend.position = "none")+scale_y_continuous(limits=c(0,25), breaks=c(0,2,4,6,8,10,12,14,16,18,20,22,24))+ geom_text(aes(label=..count..),stat='count',vjust=1.5)

```

### Where are participants this week?

This was last updated on `r format(Sys.Date(), format="%B %d, %Y")`.

```{r asd, message=FALSE, warning=FALSE, echo=FALSE}

demog$current_week <- factor(demog$current_week, levels=c("Not Training Yet", "Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6", "Week 7", "Week 8", "Week 9", "Week 10", "Week 11", "Week 12", "Extension?", "Completed"))

# Snapshot of participant progress
demog %>% 
  filter(enrollment_status != "Screen failed" & enrollment_status != "Withdrawn" & enrollment_status != "Lost to Follow-Up") %>% 
  ggplot(aes(x=current_week, fill=Group)) + geom_bar() +  scale_x_discrete(drop = FALSE) + theme_bw()+
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + xlab(paste0("Plot Last Updated:", sep=" ", Sys.Date())) + ggtitle(paste0("Snapshot of Participant Progress:", sep=" ", Sys.Date())) +   labs(fill = "Randomization Group") + theme(plot.title = element_text(hjust = 0.5))


# Snapshot with record_ids?
demog %>% 
  filter(enrollment_status != "Screen failed" & enrollment_status != "Withdrawn" & enrollment_status != "Lost to Follow-Up") %>% 
  ggplot(aes(x=current_week, fill=factor(record_id))) + geom_bar() +  scale_x_discrete(drop = FALSE) + theme_bw()+
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + xlab(paste0("Plot Last Updated:", sep=" ", Sys.Date())) + ggtitle(paste0("Snapshot of Participant Progress:", sep=" ", Sys.Date())) +   labs(fill = "Participant ID") + theme(plot.title = element_text(hjust = 0.5))

```


### Progress toward filling 4 strata!
```{r progressstrata, message=FALSE, warning=FALSE, echo=FALSE}

# Create sex + agebin variable
demog$strata[demog$sex == "Female" & demog$agegroup == "18-35 yrs"]<-"F, 18-35"
demog$strata[demog$sex == "Female" & demog$agegroup == "35-55 yrs"]<-"F, 35-55"
demog$strata[demog$sex == "Male" & demog$agegroup == "18-35 yrs"]<-"M, 18-35"
demog$strata[demog$sex == "Male" & demog$agegroup == "35-55 yrs"]<-"M, 35-55"

cohort<-demog %>% 
  filter(enrollment_status == "On-going Randomized" | enrollment_status == "Completed")

# Progress Toward Filling 4 Strata (M, F, 18-35 yrs, 35-55 yrs)

cohort %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+facet_wrap(~strata)+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste("On-going randomized or completed: n=", sep="", length(unique(cohort$record_id)))) + guides(alpha = "none")

```

### Participant Forecast
Note: these are projected dates for start and finish, but do not represent precise dates.

Ex: participants -- especially "New Participants" in purple -- listed in November may be in November and/or December. Dates will become more accurate after visits have occurred & participants officially begin training.

This excludes participants who have screen failed, withdrawn, or been lost to follow-up, so this represents our forecasted participant numbers.


```{r next, message=FALSE, warning=FALSE, echo=FALSE}

# with record_id
demog$record_id <- as.factor(demog$record_id)

# list current date
currentDate <- Sys.Date()


# Convert the start_month column to a Date object
demog$start_month <- as.Date(paste0("01 ", demog$start_month), format = "%d %b %Y")
demog$end_month <- as.Date(paste0("01 ", demog$end_month), format = "%d %b %Y")

num_eligible<-demog %>%
  filter(enrollment_status != "Screen failed" & enrollment_status != "Withdrawn" & enrollment_status != "Lost to Follow-Up") %>% 
  count()


# Projected start months
demog %>%
  filter(enrollment_status != "Screen failed" & enrollment_status != "Withdrawn" & enrollment_status != "Lost to Follow-Up") %>% 
  ggplot(aes(x = start_month, fill=Group, alpha=0.5)) + scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  geom_histogram(binwidth = 15) + ggtitle(paste0("Projected Start Months for n=", sep = "", num_eligible)) + scale_alpha(guide = 'none') + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = as.numeric(currentDate), linetype = "dashed", color = "black", size = 0.5) + xlab("Start Month")


# Projected end months
demog %>%
  filter(enrollment_status != "Screen failed" & enrollment_status != "Withdrawn" & enrollment_status != "Lost to Follow-Up") %>% 
  ggplot(aes(x = end_month, fill=Group, alpha=0.5)) +scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  geom_bar() + ggtitle(paste0("Projected End Months for n=", sep = "", num_eligible)) +scale_alpha(guide = 'none') + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + theme(plot.title = element_text(hjust = 0.5)) + geom_vline(xintercept = as.numeric(currentDate), linetype = "dashed", color = "black", size = 0.5) + xlab("End Month")

```

*Thanks everybody for your hard work!*



