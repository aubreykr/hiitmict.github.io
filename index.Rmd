---
title: "HIIT vs. MICT"
output: 
  html_document:
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
---
This is designed to track study progress! Below is a weekly update.

```{r setup, include=FALSE}
# Load packages
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(table1)
library(lubridate)
library(shiny)
library(knitr)
library(kableExtra)
```


```{r demog, message=FALSE, warning=FALSE, echo=FALSE}
demog<-read.csv("/Users/aubreykr/Desktop/demog.csv")
```

## Where are participants this week?

This was last updated on `r format(Sys.Date(), format="%B %d, %Y")`.

```{r asd, message=FALSE, warning=FALSE, echo=FALSE}

# if missing, they have enrolled and update this
demog$enrollment_status[is.na(demog$enrollment_status) == TRUE] <- "Enrolled (not screened yet)"

demog$current_week <- factor(demog$current_week, levels=c("Week 1", "Week 2", "Week 3", "Week 4", "Week 5", "Week 6", "Week 7", "Week 8", "Week 9", "Week 10", "Week 11", "Week 12", "Week 13", "Week 14", "Week 15", "Week 16", "Week 17", "Week 18", "Beyond Week 18?"))

# number of participants currently training
num<-length(demog$record_id[demog$enrollment_status== "On-going Randomized" & is.na(demog$current_week)==FALSE])

# withdrawn participants: distinguish participants who started training vs. withdrew before study
demog$enrollment_status[demog$enrollment_status == "Withdrawn" & is.na(demog$start_month)==FALSE] <- "Withdrew after training"
demog$enrollment_status[demog$enrollment_status == "Withdrawn" & is.na(demog$start_month)==TRUE] <- "Withdrew before training"

```

```{r firstcode, message=FALSE, warning=FALSE, echo=FALSE}
# Snapshot of participant progress
demog %>% 
  filter(enrollment_status == "On-going Randomized" & current_week !="Not Training Yet") %>% 
  ggplot(aes(x=current_week, fill=factor(record_id))) + geom_bar() +  scale_x_discrete(drop = FALSE) + theme_bw()+
theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) + xlab(paste0("Plot Last Updated:", sep=" ", Sys.Date())) + ggtitle(paste0(num, sep=" ", "individuals are currently training")) +   labs(fill = "Record ID") + theme(plot.title = element_text(hjust = 0.5))+ scale_y_continuous(breaks = seq(0, 30, 2)) + geom_text(aes(label = record_id, y = ..count..), 
            stat = "count", 
            position = position_stack(vjust = 0.5), 
            color = "black", size = 3)
```

## How many workouts have they done?

### On-going participants
```{r workouts0, message=FALSE, warning=FALSE, echo=FALSE}
# Filter for participants who are on-going and not controls
training<-demog %>% 
  filter(enrollment_status == "On-going Randomized" & Group != "Control" & current_week !="Not Training Yet") %>% 
  dplyr::select(record_id, current_week, Group, quality_workouts_in_REDCap, total_workouts_in_REDCap, quality_fraction, training_status, sex, agegroup)

training %>% 
  arrange(current_week) %>% 
  kable() %>%
  kable_styling()
```


### Completed MICT participants
```{r workouts,message=FALSE, warning=FALSE, echo=FALSE}

# Filter for participants who are completed and MICT
completed_mict<-demog %>% 
  filter(enrollment_status == "Completed" & Group == "MICT") %>% 
  dplyr::select(record_id, quality_workouts_in_REDCap, percent_complete_of_36_wkts, sex, agegroup)

completed_mict %>% 
    arrange(quality_workouts_in_REDCap) %>% 
  kable() %>%
  kable_styling()
```

### Completed HIIT participants
```{r workouts2,message=FALSE, warning=FALSE, echo=FALSE}
# Filter for participants who are completed and HIIT
completed_hiit<-demog %>% 
  filter(enrollment_status == "Completed" & Group == "HIIT") %>% 
  dplyr::select(record_id, quality_workouts_in_REDCap, percent_complete_of_36_wkts, sex, agegroup)

completed_hiit %>% 
  arrange(quality_workouts_in_REDCap) %>% 
  kable() %>%
  kable_styling()
```

## Study Progress
```{r newppl, message=FALSE, warning=FALSE, echo=FALSE}
# Order levels of enrollment status
demog$enrollment_status <- factor(demog$enrollment_status, levels = c("Enrolled (not screened yet)", "Lost to Follow-Up", "Screen failed", "Withdrew before training","On-going Randomized", "Withdrew after training", "Completed"))

ggplot(aes(x=enrollment_status, fill = enrollment_status, alpha=0.8), data=demog)+geom_bar(stat="count")+
  ggtitle(paste("Total Participants: n=", sep="", length(unique(demog$record_id)))) + theme(plot.title = element_text(hjust = 0.5))+xlab("Participant Status")+ylab("Number")+scale_fill_discrete(name = "Group")+theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+theme(legend.position = "none")+scale_y_continuous(limits=c(0,25), breaks=c(0,2,4,6,8,10,12,14,16,18,20,22,24))+ geom_text(aes(label=..count..),stat='count',vjust=1.5)
```


## Progress toward filling 4 strata
```{r progressstrata, message=FALSE, warning=FALSE, echo=FALSE}

# Create sex + agebin variable
demog$strata[demog$sex == "Female" & demog$agegroup == "18-35 yrs"]<-"F, 18-35"
demog$strata[demog$sex == "Female" & demog$agegroup == "35-55 yrs"]<-"F, 35-55"
demog$strata[demog$sex == "Male" & demog$agegroup == "18-35 yrs"]<-"M, 18-35"
demog$strata[demog$sex == "Male" & demog$agegroup == "35-55 yrs"]<-"M, 35-55"

cohort<-demog %>% 
  filter(enrollment_status == "On-going Randomized" | enrollment_status == "Completed")

# Progress Toward Filling 4 Strata (M, F, 18-35 yrs, 35-55 yrs)

cohort %>% 
  ggplot(aes(x=Group, fill=Group, alpha=0.8))+geom_bar(stat="count")+
  theme(plot.title = element_text(hjust = 0.5))+xlab("Group")+ylab("Number")+scale_fill_discrete(name = "Group")+facet_wrap(~strata)+
  geom_text(aes(label=..count..),stat='count',vjust=1.5) + 
  ggtitle(paste("On-going Randomized or Completed Study: n=", sep="", length(unique(cohort$record_id)))) + guides(alpha = "none")

```


*Thanks everybody for your hard work!*

```{r bodyfat, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}

# calculated variables
demog<-demog %>% 
  mutate(delta_VO2 = ep_vo2_max - bl_vo2_max,
         delta_bodyfat = ep_percent_body_fat - bl_percent_body_fat,
         delta_BMI = ep_bmi - bl_bmi)

demog %>% 
  filter(enrollment_status == "Completed") %>% 
  group_by(Group) %>% 
  summarize(mean = median(delta_VO2),
            sd = sd(delta_VO2))

demog %>% 
  filter(enrollment_status == "Completed") %>% 
  group_by(Group) %>% 
  summarize(median = median(delta_bodyfat))

# delta plots
demog %>% 
  filter(enrollment_status == "Completed") %>% 
  ggplot(aes(x=Group, y=delta_VO2, color=sex, group=Group)) + geom_boxplot() + geom_point()  + geom_hline(yintercept = 0, linetype="dotted") + 
  ggtitle("Delta VO2 max") + theme(plot.title = element_text(hjust = 0.5)) 

demog %>% 
  filter(enrollment_status == "Completed" & is.na(delta_bodyfat)==FALSE) %>% 
  ggplot(aes(x=Group, y=delta_bodyfat, color=sex, group=Group)) + geom_boxplot() + geom_point()  + geom_hline(yintercept = 0, linetype="dotted") + 
  ggtitle("Delta body fat") + theme(plot.title = element_text(hjust = 0.5)) 

demog %>% 
  filter(enrollment_status == "Completed" & is.na(delta_BMI)==FALSE) %>% 
  ggplot(aes(x=Group, y=delta_BMI, color=sex, group=Group)) + geom_boxplot() + geom_point()  + geom_hline(yintercept = 0, linetype="dotted") + 
  ggtitle("Delta BMI") + theme(plot.title = element_text(hjust = 0.5)) 

```




